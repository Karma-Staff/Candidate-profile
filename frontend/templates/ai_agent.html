{% extends "base.html" %}

{% block content %}
<style>
    #chatHistory::-webkit-scrollbar {
        display: none;
    }

    .main-container {
        padding-bottom: 0 !important;
    }

    .message-actions {
        display: flex;
        gap: 0.125rem;
        margin-top: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
        padding-left: 0.25rem;
    }

    .agent-message-wrapper:hover .message-actions {
        opacity: 1;
    }

    .action-btn {
        background: transparent;
        border: none;
        color: var(--text-lighter);
        padding: 0.375rem;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-light);
    }

    .action-btn.active {
        color: var(--accent);
    }

    .action-btn i {
        width: 14px;
        height: 14px;
    }
</style>

<!-- Full-height Chat Layout -->
<div style="display: flex; flex-direction: column; height: calc(100vh - 80px); gap: 0;">

    <!-- Conversation Card (fills all space) -->
    <div class="card"
        style="flex: 1; padding: 0; display: flex; flex-direction: column; overflow: hidden; border-radius: var(--radius-xl); margin: 0;">

        <!-- Compact Header Bar inside the card -->
        <div
            style="padding: 1rem 1.75rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: rgba(15, 23, 42, 0.4); flex-shrink: 0;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent), #818cf8); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    {% if user.role == 'client' %}
                    <i data-lucide="sparkles" style="width: 20px; height: 20px; color: white;"></i>
                    {% else %}
                    <i data-lucide="bot" style="width: 20px; height: 20px; color: white;"></i>
                    {% endif %}
                </div>
                <div>
                    <div
                        style="font-weight: 700; font-size: 1.0625rem; display: flex; align-items: center; gap: 0.5rem;">
                        {% if user.role == 'client' %}
                        Recruiter AI
                        <span class="badge badge-info" style="font-weight: 700; font-size: 0.5625rem;">
                            <i data-lucide="sparkles" style="width: 8px;"></i> AI Powered
                        </span>
                        {% else %}
                        AI Talent Agent
                        <span class="badge badge-success" style="font-weight: 700; font-size: 0.5625rem;">
                            <i data-lucide="shield" style="width: 8px;"></i> Admin
                        </span>
                        {% endif %}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-lighter);">
                        {% if user.role == 'client' %}
                        Find the perfect virtual team member for your business
                        {% else %}
                        Analyze candidates, evaluate fit, get structured reports
                        {% endif %}
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-ghost"
                    style="border-radius: 8px; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; font-weight: 600; color: var(--text-light);"
                    onclick="location.reload()">
                    <i data-lucide="plus" style="width: 16px;"></i>
                    New Chat
                </button>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div id="chatHistory"
            style="flex: 1; overflow-y: auto; padding: 2rem 2.5rem; display: flex; flex-direction: column; gap: 1.25rem; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none;">

            <!-- Welcome View -->
            <div id="welcomeView"
                style="margin: auto 0; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 1rem 0;">
                <div
                    style="width: 72px; height: 72px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(129, 140, 248, 0.08)); border: 1px solid rgba(59, 130, 246, 0.15); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; animation: float 3s ease-in-out infinite;">
                    {% if user.role == 'client' %}
                    <i data-lucide="sparkles" style="width: 32px; height: 32px; color: var(--accent);"></i>
                    {% else %}
                    <i data-lucide="bot" style="width: 32px; height: 32px; color: var(--accent);"></i>
                    {% endif %}
                </div>

                <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem; font-weight: 800; letter-spacing: -0.02em;">
                    {% if user.role == 'client' %}Hi there! üëã{% else %}Talent Intelligence{% endif %}
                </h2>
                <p
                    style="color: var(--text-light); max-width: 460px; font-size: 0.9375rem; margin-bottom: 2rem; line-height: 1.6;">
                    {% if user.role == 'client' %}
                    I'm your dedicated recruiter assistant. Tell me about the role you're hiring for, or pick a quick
                    option below.
                    {% else %}
                    Analyze candidates, evaluate client-candidate fit, and get AI-powered structured recommendations.
                    {% endif %}
                </p>

                <!-- Quick Action Pills -->
                {% if user.role == 'client' %}
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; width: 100%; max-width: 520px;">
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('I need an Office Admin')">
                        <span style="font-size: 1.125rem;">üë©‚Äçüíº</span> <span style="font-weight: 600;">Office
                            Admin</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Help me find a Project Manager')">
                        <span style="font-size: 1.125rem;">üìã</span> <span style="font-weight: 600;">Project
                            Manager</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Who\'s available right now?')">
                        <span style="font-size: 1.125rem;">‚ö°</span> <span style="font-weight: 600;">Available Now</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Not sure what I need')">
                        <span style="font-size: 1.125rem;">üßê</span> <span style="font-weight: 600;">Help Me
                            Decide</span>
                    </div>
                </div>
                {% else %}
                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; width: 100%; max-width: 520px;">
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Analyze all candidates')">
                        <span>üìä</span> <span style="font-weight: 600;">Analyze All</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Rank for Office Admin')">
                        <span>üèÜ</span> <span style="font-weight: 600;">Rank for Admin</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Find immediate hires')">
                        <span>üîç</span> <span style="font-weight: 600;">Immediate Hires</span>
                    </div>
                    <div class="action-pill" style="justify-content: center; padding: 1rem;"
                        onclick="sendQuickMessage('Review all candidate profiles and recommend specific improvements for each to increase their appeal to U.S. small business owners.')">
                        <span>üìù</span> <span style="font-weight: 600;">Improve Profiles</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Input Area -->
        <div
            style="padding: 1rem 1.75rem; border-top: 1px solid var(--border); background: rgba(15, 23, 42, 0.4); flex-shrink: 0;">
            <div style="display: flex; align-items: center; gap: 0.75rem; background: var(--glass); border: 1px solid var(--border); border-radius: 12px; padding: 0.375rem 0.375rem 0.375rem 1.25rem; transition: border-color 0.2s;"
                id="inputBox" onfocusin="this.style.borderColor='var(--accent)'"
                onfocusout="this.style.borderColor='var(--border)'">
                <input type="text" id="userInput"
                    style="flex: 1; background: transparent; border: none; color: var(--text); outline: none; font-size: 0.9375rem; font-family: inherit; padding: 0.5rem 0;"
                    placeholder="{% if user.role == 'client' %}Tell me about the role you're looking to fill...{% else %}Ask about candidates, roles, or talent analysis...{% endif %}"
                    onkeypress="handleKeyPress(event)" autocomplete="off">
                <button onclick="sendMessage()" id="sendBtn"
                    style="background: linear-gradient(135deg, var(--accent), #2563eb); color: white; border: none; width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); flex-shrink: 0;">
                    <i data-lucide="arrow-up" style="width: 18px;"></i>
                </button>
            </div>
            <div style="text-align: center; margin-top: 0.5rem; font-size: 0.6875rem; color: var(--text-lighter);">
                Powered by Gemini AI ¬∑ Responses may not always be accurate
            </div>
        </div>
    </div>
</div>

<script>
    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const welcomeView = document.getElementById('welcomeView');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(role, text) {
        if (welcomeView) welcomeView.style.display = 'none';

        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';
        wrapper.style.animation = 'fadeInUp 0.3s ease forwards';

        const bubble = document.createElement('div');
        bubble.style.maxWidth = '75%';
        bubble.style.padding = '0.875rem 1.125rem';
        bubble.style.fontSize = '0.9375rem';
        bubble.style.lineHeight = '1.7';
        bubble.style.whiteSpace = 'pre-wrap';
        bubble.style.wordBreak = 'break-word';

        if (role === 'user') {
            bubble.style.background = 'linear-gradient(135deg, var(--accent), #2563eb)';
            bubble.style.color = 'white';
            bubble.style.borderRadius = '16px 16px 4px 16px';
            bubble.style.boxShadow = '0 2px 12px rgba(59, 130, 246, 0.25)';
        } else {
            bubble.style.background = 'var(--glass-strong)';
            bubble.style.border = '1px solid var(--border)';
            bubble.style.color = 'var(--text)';
            bubble.style.borderRadius = '16px 16px 16px 4px';
        }

        bubble.innerHTML = text
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');

        if (role === 'agent') {
            wrapper.classList.add('agent-message-wrapper');
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'flex-start';

            const actions = document.createElement('div');
            actions.className = 'message-actions';
            actions.innerHTML = `
                <button class="action-btn" title="Copy" onclick="copyToClipboard(this, \`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                    <i data-lucide="copy"></i>
                </button>
                <button class="action-btn" title="Like" onclick="toggleAction(this)">
                    <i data-lucide="thumbs-up"></i>
                </button>
                <button class="action-btn" title="Dislike" onclick="toggleAction(this)">
                    <i data-lucide="thumbs-down"></i>
                </button>
                <button class="action-btn" title="Pin" onclick="toggleAction(this)">
                    <i data-lucide="pin"></i>
                </button>
                <button class="action-btn" title="Share" onclick="shareMessage(\`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                    <i data-lucide="share-2"></i>
                </button>
                <button class="action-btn" title="Regenerate" onclick="regenerateLast()">
                    <i data-lucide="refresh-cw"></i>
                </button>
                <button class="action-btn" title="More">
                    <i data-lucide="more-horizontal"></i>
                </button>
            `;

            wrapper.appendChild(bubble);
            wrapper.appendChild(actions);
        } else {
            wrapper.appendChild(bubble);
        }

        chatHistory.appendChild(wrapper);
        lucide.createIcons();
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function copyToClipboard(btn, text) {
        const originalHtml = btn.innerHTML;
        navigator.clipboard.writeText(text).then(() => {
            btn.innerHTML = '<i data-lucide="check" style="color: #22c55e;"></i>';
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                lucide.createIcons();
            }, 2000);
        });
    }

    function toggleAction(btn) {
        btn.classList.toggle('active');
        const icon = btn.querySelector('i');
        // Simple visual feedback for like/dislike
        if (btn.title === 'Like' && btn.classList.contains('active')) {
            const dislike = btn.parentElement.querySelector('[title="Dislike"]');
            if (dislike) dislike.classList.remove('active');
        } else if (btn.title === 'Dislike' && btn.classList.contains('active')) {
            const like = btn.parentElement.querySelector('[title="Like"]');
            if (like) like.classList.remove('active');
        }
    }

    function shareMessage(text) {
        if (navigator.share) {
            navigator.share({
                title: 'Karma Staff AI Agent',
                text: text,
                url: window.location.href
            }).then(() => {
                console.log('Successful share');
            }).catch((error) => {
                console.log('Error sharing', error);
            });
        } else {
            // Fallback: Copy content and show a small notification
            navigator.clipboard.writeText(text).then(() => {
                alert("Link/Content copied to clipboard for sharing.");
            });
        }
    }

    let lastUserMessage = "";

    function regenerateLast() {
        if (lastUserMessage) {
            userInput.value = lastUserMessage;
            sendMessage();
        }
    }

    function showTyping() {
        const el = document.createElement('div');
        el.id = 'typingIndicator';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.gap = '0.625rem';
        el.style.padding = '0.875rem 1.125rem';
        el.style.background = 'var(--glass)';
        el.style.border = '1px solid var(--border)';
        el.style.borderRadius = '16px 16px 16px 4px';
        el.style.width = 'fit-content';
        el.style.animation = 'fadeIn 0.2s ease';
        el.innerHTML = `
            <div style="display: flex; gap: 5px;">
                <span style="width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 1s ease-in-out infinite;"></span>
                <span style="width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 1s ease-in-out 0.15s infinite;"></span>
                <span style="width: 7px; height: 7px; background: var(--accent); border-radius: 50%; animation: pulse 1s ease-in-out 0.3s infinite;"></span>
            </div>
            <span style="font-size: 0.8125rem; color: var(--text-lighter);">Thinking...</span>`;
        chatHistory.appendChild(el);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function removeTyping() {
        const el = document.getElementById('typingIndicator');
        if (el) el.remove();
    }

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        userInput.value = '';
        lastUserMessage = text;
        appendMessage('user', text);
        showTyping();

        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            removeTyping();
            appendMessage('agent', data.response || data.error || "Something went wrong.");
        } catch (err) {
            removeTyping();
            appendMessage('agent', "‚ö†Ô∏è Connection lost. Please check your internet and try again.");
        } finally {
            sendBtn.disabled = false;
            sendBtn.style.opacity = '1';
            userInput.focus();
        }
    }

    function handleKeyPress(e) {
        if (e.key === 'Enter') sendMessage();
    }

    function sendQuickMessage(text) {
        userInput.value = text;
        sendMessage();
    }

    // Auto-focus input on load
    userInput.focus();


</script>
{% endblock %}