{% extends "base.html" %}

{% block content %}
<style>
    .user-avatar[data-role-cat="admin"] {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .user-avatar[data-role-cat="client"] {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .user-avatar[data-role-cat="other"] {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent);
    }

    .badge-role[data-role-cat="admin"] {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .badge-role[data-role-cat="client"] {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .badge-role[data-role-cat="other"] {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent);
    }
</style>

<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1>User Management</h1>
        <p>Manage platform users and access roles</p>
    </div>
    <button class="btn btn-primary" onclick="toggleModal(true)">
        <i data-lucide="plus" style="width: 16px;"></i> Add User
    </button>
</div>

<div class="tabs animate-in delay-1" id="userTabs">
    <div class="tab active" data-filter="all" onclick="filterUsers('all', this)">All Users</div>
    <div class="tab" data-filter="admin" onclick="filterUsers('admin', this)">Admin</div>
    <div class="tab" data-filter="cs" onclick="filterUsers('cs', this)">Customer Service</div>
    <div class="tab" data-filter="client" onclick="filterUsers('client', this)">Client</div>
</div>

<div class="user-list animate-in delay-2" id="userList">
    {% for u in all_users %}
    <div class="user-item" data-role="{{ u.role }}" style="opacity: 0; display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: var(--glass); border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid var(--border);
        --delay: {{ loop.index * 0.06 }}s; animation: fadeInUp 0.4s ease forwards var(--delay);">

        <div class="user-info-main" style="display: flex; align-items: center; gap: 1rem;">
            {% if u.avatar_url %}
            <div class="user-avatar"
                style="width: 44px; height: 44px; border-radius: 10px; overflow: hidden; border: 2px solid var(--border); flex-shrink: 0;">
                <img src="{{ u.avatar_url }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            {% else %}
            <div class="user-avatar"
                data-role-cat="{{ 'admin' if u.role == 'admin' else 'client' if u.role == 'client' else 'other' }}"
                style="width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">


                <i data-lucide="{{ 'shield' if u.role == 'admin' else 'briefcase' if u.role == 'client' else 'user-cog' }}"
                    style="width: 20px;"></i>
            </div>
            {% endif %}
            <div>
                <div style="font-weight: 600; font-size: 1rem; color: white;">{{ u.username }}</div>
                <div style="color: var(--text-lighter); font-size: 0.8125rem;">
                    {{ u.email or 'No email provided' }}
                </div>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 1rem;">
            <span class="badge badge-{{ u.role }} badge-role"
                data-role-cat="{{ 'admin' if u.role == 'admin' else 'client' if u.role == 'client' else 'other' }}"
                style="font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 100px; font-weight: 600; text-transform: capitalize; border: 1px solid currentColor;">

                {{ 'Customer Service' if u.role == 'cs' else u.role }}
            </span>

            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-ghost" title="Edit User" onclick="openEditModal({{ u.id }})"
                    style="color: var(--accent); padding: 0.5rem; border-radius: 8px;">
                    <i data-lucide="edit-2" style="width: 18px;"></i>
                </button>

                {% if u.id != user.id %}
                <button class="btn-ghost" title="Delete User" onclick="confirmDelete({{ u.id }}, '{{ u.username }}')"
                    style="color: var(--error); padding: 0.5rem; border-radius: 8px;">
                    <i data-lucide="trash-2" style="width: 18px;"></i>
                </button>
                {% else %}
                <div style="width: 34px;"></div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Progress/Toast overlay -->
<div id="toast"
    style="position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; background: var(--glass-strong); border: 1px solid var(--border); border-radius: var(--radius); display: none; z-index: 1000; animation: fadeInUp 0.3s ease;">
    <span id="toast-message"></span>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal-overlay" style="display: none;">
    <div class="card modal-content" style="position: relative; max-width: 600px;">
        <button onclick="toggleModal(false)" class="btn-ghost"
            style="position: absolute; right: 1.25rem; top: 1.25rem;">
            <i data-lucide="x" style="width: 20px;"></i>
        </button>

        <h2 id="modalTitle" style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
            <div
                style="width: 36px; height: 36px; background: var(--accent-subtle); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="user-plus" id="modalIcon" style="width: 18px; color: var(--accent);"></i>
            </div>
            <span>Create New User</span>
        </h2>

        <form id="userForm">
            <input type="hidden" name="user_id" id="editUserId">
            <div style="display: flex; gap: 2rem; margin-bottom: 2rem; align-items: flex-start;">
                <!-- Avatar Upload Section (Only for Create) -->
                <div id="avatarSection" style="flex-shrink: 0; text-align: center;">
                    <div id="avatarPreview"
                        style="width: 100px; height: 100px; border-radius: 50%; background: var(--glass); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 0.75rem; cursor: pointer;"
                        onclick="document.getElementById('avatarInput').click()">
                        <i data-lucide="camera" style="width: 32px; color: var(--text-lighter);"></i>
                    </div>
                    <input type="file" name="avatar" id="avatarInput" style="display: none;" accept="image/*"
                        onchange="previewAvatar(this)">
                    <button type="button" class="btn btn-ghost" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;"
                        onclick="document.getElementById('avatarInput').click()">
                        Upload Photo
                    </button>
                </div>

                <div style="flex: 1; display: grid; grid-template-columns: 1fr; gap: 1.25rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="username" id="modalUsername" class="search-input"
                            style="padding: 0.75rem 1rem;" placeholder="John Doe" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" id="modalEmail" class="search-input"
                            style="padding: 0.75rem 1rem;" placeholder="john@example.com" required>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">Role</label>
                <input type="hidden" name="role" id="roleInput" value="client">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="roleSelector">
                    <div class="card role-option" style="padding: 1rem; cursor: pointer; text-align: center;"
                        data-role="admin" onclick="selectRole(this)">
                        <i data-lucide="shield" style="width: 24px; color: var(--warning); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">Admin</div>
                    </div>
                    <div class="card role-option" style="padding: 1rem; cursor: pointer; text-align: center;"
                        data-role="cs" onclick="selectRole(this)">
                        <i data-lucide="headphones"
                            style="width: 24px; color: var(--accent); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">CS</div>
                    </div>
                    <div class="card role-option selected"
                        style="padding: 1rem; cursor: pointer; text-align: center; border-color: var(--success); background: rgba(16, 185, 129, 0.05);"
                        data-role="client" onclick="selectRole(this)">
                        <i data-lucide="briefcase"
                            style="width: 24px; color: var(--success); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">Client</div>
                    </div>
                </div>
            </div>

            <div id="clientOnboardingSection"
                style="padding: 1.25rem; background: var(--glass); border: 1px dashed var(--border); border-radius: var(--radius); margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; color: var(--success); font-weight: 600; margin-bottom: 1rem;">
                    <i data-lucide="clipboard-list" style="width: 16px;"></i> Client Onboarding (Optional)
                </label>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">What help do they need?</label>
                    <textarea name="help_needs" class="search-input"
                        style="padding: 0.75rem 1rem; min-height: 70px; resize: vertical;"
                        placeholder="E.g. Handling insurance claims, managing crews..."></textarea>
                </div>
                <div>
                    <label class="form-label">What software do they use?</label>
                    <textarea name="software_usage" class="search-input"
                        style="padding: 0.75rem 1rem; min-height: 70px; resize: vertical;"
                        placeholder="E.g. Xactimate, Dash, QuickBooks..."></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button type="submit" id="modalSubmitBtn" class="btn btn-primary" style="padding: 0.75rem 2rem;">
                    <i data-lucide="check" style="width: 16px;"></i> <span>Create User</span>
                </button>
                <button type="button" class="btn btn-outline" style="padding: 0.75rem 2rem;"
                    onclick="toggleModal(false)">
                    Cancel
                </button>
            </div>
        </form>

        <div id="defaultPasswordTip" style="font-size: 0.75rem; color: var(--text-lighter);">
            Default password: <code
                style="padding: 0.125rem 0.375rem; background: var(--glass-strong); border-radius: 4px; color: var(--text);">demo123</code>
        </div>
    </div>
</div>

<script>
    let isEditing = false;

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.style.borderColor = isError ? 'var(--error)' : 'var(--success)';
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 3000);
    }

    function toggleModal(show, editData = null) {
        const modal = document.getElementById('userModal');
        const form = document.getElementById('userForm');
        const title = document.querySelector('#modalTitle span');
        const icon = document.getElementById('modalIcon');
        const submitBtn = document.querySelector('#modalSubmitBtn span');
        const avatarSection = document.getElementById('avatarSection');
        const passwordTip = document.getElementById('defaultPasswordTip');

        isEditing = !!editData;
        form.reset();

        if (show) {
            if (isEditing) {
                title.textContent = 'Edit User';
                submitBtn.textContent = 'Save Changes';
                icon.setAttribute('data-lucide', 'user-cog');
                avatarSection.style.display = 'none';
                passwordTip.style.display = 'none';

                document.getElementById('editUserId').value = editData.id;
                document.getElementById('modalUsername').value = editData.username;
                document.getElementById('modalEmail').value = editData.email;
                document.getElementById('roleInput').value = editData.role;

                // Select role card
                const roleEl = document.querySelector(`.role-option[data-role="${editData.role}"]`);
                if (roleEl) selectRole(roleEl);
            } else {
                title.textContent = 'Create New User';
                submitBtn.textContent = 'Create User';
                icon.setAttribute('data-lucide', 'user-plus');
                avatarSection.style.display = 'block';
                passwordTip.style.display = 'block';
                document.getElementById('editUserId').value = '';
                document.getElementById('avatarPreview').innerHTML = '<i data-lucide="camera" style="width: 32px; color: var(--text-lighter);"></i>';
                selectRole(document.querySelector('.role-option[data-role="client"]'));
            }
            modal.style.display = 'flex';
            lucide.createIcons();
        } else {
            modal.style.display = 'none';
        }
    }

    async function openEditModal(userId) {
        try {
            const response = await fetch(`/api/users/${userId}`);
            const user = await response.json();
            if (user.id) {
                toggleModal(true, user);
            } else {
                showToast(user.message || 'Error fetching user', true);
            }
        } catch (error) {
            showToast('Connection error', true);
        }
    }

    document.getElementById('userForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = document.getElementById('modalSubmitBtn');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Processing...';

        const url = isEditing ? `/api/users/update/${document.getElementById('editUserId').value}` : '/api/users/create';

        try {
            let response;
            if (isEditing) {
                // For editing, we send JSON
                const jsonData = Object.fromEntries(formData.entries());
                response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(jsonData)
                });
            } else {
                // For creation, we send FormData (for avatar upload)
                response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
            }

            const result = await response.json();
            if (result.success) {
                showToast(result.message);
                toggleModal(false);
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast(result.message || 'Action failed', true);
            }
        } catch (error) {
            showToast('Connection error', true);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            lucide.createIcons();
        }
    });

    async function confirmDelete(userId, username) {
        if (!confirm(`Are you sure you want to delete ${username}?`)) return;

        try {
            const response = await fetch(`/api/users/delete/${userId}`, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message);
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast(result.message || 'Error deleting user', true);
            }
        } catch (error) {
            showToast('Connection error', true);
        }
    }

    function filterUsers(role, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');

        document.querySelectorAll('.user-item').forEach(item => {
            if (role === 'all' || item.dataset.role === role) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function selectRole(el) {
        document.querySelectorAll('.role-option').forEach(r => {
            r.classList.remove('selected');
            r.style.borderColor = 'var(--border)';
            r.style.background = 'var(--glass)';
        });
        el.classList.add('selected');
        const role = el.dataset.role;
        document.getElementById('roleInput').value = role;
        const colors = { admin: 'var(--warning)', cs: 'var(--accent)', client: 'var(--success)' };
        el.style.borderColor = colors[role];
        el.style.background = `rgba(${role === 'admin' ? '245, 158, 11' : role === 'cs' ? '59, 130, 246' : '16, 185, 129'}, 0.05)`;
    }

    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}