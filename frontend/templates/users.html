{% extends "base.html" %}

{% block content %}
<style>
    .user-avatar {
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .user-avatar:hover {
        transform: scale(1.05);
        border-color: var(--accent) !important;
    }

    .user-avatar[data-role-cat="admin"] {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .user-avatar[data-role-cat="client"] {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .user-avatar[data-role-cat="other"] {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent);
    }

    .badge-role[data-role-cat="admin"] {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .badge-role[data-role-cat="client"] {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .badge-role[data-role-cat="other"] {
        background: rgba(59, 130, 246, 0.1);
        color: var(--accent);
    }
</style>

<div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
        <h1>User Management</h1>
        <p>Manage platform users and access roles</p>
    </div>
    <button class="btn btn-primary" onclick="toggleModal(true)">
        <i data-lucide="plus" style="width: 16px;"></i> Add User
    </button>
</div>

<div class="tabs animate-in delay-1" id="userTabs">
    <div class="tab active" data-filter="all" onclick="filterUsers('all', this)">All Users</div>
    <div class="tab" data-filter="admin" onclick="filterUsers('admin', this)">Admin</div>
    <div class="tab" data-filter="cs" onclick="filterUsers('cs', this)">Customer Service</div>
    <div class="tab" data-filter="client" onclick="filterUsers('client', this)">Client</div>
</div>

<div class="user-list animate-in delay-2" id="userList">
    {% for u in all_users %}
    <div class="user-item" data-role="{{ u.role }}" style="opacity: 0; display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: var(--glass); border-radius: var(--radius); margin-bottom: 1rem; border: 1px solid var(--border);
        --delay: {{ loop.index * 0.06 }}s; animation: fadeInUp 0.4s ease forwards var(--delay);">

        <div class="user-info-main" style="display: flex; align-items: center; gap: 1rem;">
            {% if u.avatar_url %}
            <div class="user-avatar" onclick="showImagePreview('{{ u.avatar_url }}')"
                style="width: 44px; height: 44px; border-radius: 10px; overflow: hidden; border: 2px solid var(--border); flex-shrink: 0;">
                <img src="{{ u.avatar_url }}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            {% else %}
            <div class="user-avatar" onclick="showImagePreview(null, '{{ u.role }}')"
                data-role-cat="{{ 'admin' if u.role == 'admin' else 'client' if u.role == 'client' else 'other' }}"
                style="width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">


                <i data-lucide="{{ 'shield' if u.role == 'admin' else 'briefcase' if u.role == 'client' else 'user-cog' }}"
                    style="width: 20px;"></i>
            </div>
            {% endif %}
            <div>
                <div style="font-weight: 600; font-size: 1rem; color: white;">{{ u.username }}</div>
                <div style="color: var(--text-lighter); font-size: 0.8125rem;">
                    {{ u.email or 'No email provided' }}
                </div>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 1rem;">
            <span class="badge badge-{{ u.role }} badge-role"
                data-role-cat="{{ 'admin' if u.role == 'admin' else 'client' if u.role == 'client' else 'other' }}"
                style="font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 100px; font-weight: 600; text-transform: capitalize; border: 1px solid currentColor;">

                {{ 'Customer Service' if u.role == 'cs' else u.role }}
            </span>

            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn-ghost" title="View Activity Logs"
                    onclick="openLogsModal({{ u.id }}, '{{ u.username }}')"
                    style="color: var(--text-lighter); padding: 0.5rem; border-radius: 8px;"
                    onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-lighter)'">
                    <i data-lucide="scroll-text" style="width: 18px;"></i>
                </button>
                <button class="btn-ghost" title="Edit User" onclick="openEditModal({{ u.id }})"
                    style="color: var(--accent); padding: 0.5rem; border-radius: 8px;">
                    <i data-lucide="edit-2" style="width: 18px;"></i>
                </button>

                {% if u.id != user.id %}
                <button class="btn-ghost" title="Delete User" onclick="confirmDelete({{ u.id }}, '{{ u.username }}')"
                    style="color: var(--error); padding: 0.5rem; border-radius: 8px;">
                    <i data-lucide="trash-2" style="width: 18px;"></i>
                </button>
                {% else %}
                <div style="width: 34px;"></div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>



<!-- Add/Edit User Modal -->
<div id="userModal" class="modal-overlay" style="display: none;">
    <div class="card modal-content" style="position: relative; max-width: 600px;">
        <button onclick="toggleModal(false)" class="btn-ghost"
            style="position: absolute; right: 1.25rem; top: 1.25rem;">
            <i data-lucide="x" style="width: 20px;"></i>
        </button>

        <h2 id="modalTitle" style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
            <div
                style="width: 36px; height: 36px; background: var(--accent-subtle); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                <i data-lucide="user-plus" id="modalIcon" style="width: 18px; color: var(--accent);"></i>
            </div>
            <span>Create New User</span>
        </h2>

        <form id="userForm">
            <input type="hidden" name="user_id" id="editUserId">
            <input type="hidden" name="current_avatar" id="currentAvatar">
            <div style="display: flex; gap: 2rem; margin-bottom: 2rem; align-items: flex-start;">
                <!-- Avatar Upload Section (Only for Create) -->
                <div id="avatarSection" style="flex-shrink: 0; text-align: center;">
                    <div id="avatarPreview"
                        style="width: 100px; height: 100px; border-radius: 50%; background: var(--glass); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 0.75rem; cursor: pointer;"
                        onclick="document.getElementById('avatarInput').click()">
                        <i data-lucide="camera" style="width: 32px; color: var(--text-lighter);"></i>
                    </div>
                    <input type="file" name="avatar" id="avatarInput" style="display: none;" accept="image/*"
                        onchange="previewAvatar(this)">
                    <button type="button" class="btn btn-ghost" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;"
                        onclick="document.getElementById('avatarInput').click()">
                        Upload Photo
                    </button>
                </div>

                <div style="flex: 1; display: grid; grid-template-columns: 1fr; gap: 1.25rem;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Full Name</label>
                        <input type="text" name="username" id="modalUsername" class="search-input"
                            style="padding: 0.75rem 1rem;" placeholder="John Doe" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Email Address</label>
                        <input type="email" name="email" id="modalEmail" class="search-input"
                            style="padding: 0.75rem 1rem;" placeholder="john@example.com" required>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label class="form-label" style="margin-bottom: 0.75rem;">Role</label>
                <input type="hidden" name="role" id="roleInput" value="client">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem;" id="roleSelector">
                    <div class="card role-option" style="padding: 1rem; cursor: pointer; text-align: center;"
                        data-role="admin" onclick="selectRole(this)">
                        <i data-lucide="shield" style="width: 24px; color: var(--warning); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">Admin</div>
                    </div>
                    <div class="card role-option" style="padding: 1rem; cursor: pointer; text-align: center;"
                        data-role="cs" onclick="selectRole(this)">
                        <i data-lucide="headphones"
                            style="width: 24px; color: var(--accent); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">CS</div>
                    </div>
                    <div class="card role-option selected"
                        style="padding: 1rem; cursor: pointer; text-align: center; border-color: var(--success); background: rgba(16, 185, 129, 0.05);"
                        data-role="client" onclick="selectRole(this)">
                        <i data-lucide="briefcase"
                            style="width: 24px; color: var(--success); margin-bottom: 0.5rem;"></i>
                        <div style="font-weight: 600; font-size: 0.875rem;">Client</div>
                    </div>
                </div>
            </div>

            <div id="clientOnboardingSection"
                style="padding: 1.25rem; background: var(--glass); border: 1px dashed var(--border); border-radius: var(--radius); margin-bottom: 1.5rem;">
                <label
                    style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; color: var(--success); font-weight: 600; margin-bottom: 1rem;">
                    <i data-lucide="clipboard-list" style="width: 16px;"></i> Client Onboarding (Optional)
                </label>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">What help do they need?</label>
                    <textarea name="help_needs" class="search-input"
                        style="padding: 0.75rem 1rem; min-height: 70px; resize: vertical;"
                        placeholder="E.g. Handling insurance claims, managing crews..."></textarea>
                </div>
                <div>
                    <label class="form-label">What software do they use?</label>
                    <textarea name="software_usage" class="search-input"
                        style="padding: 0.75rem 1rem; min-height: 70px; resize: vertical;"
                        placeholder="E.g. Xactimate, Dash, QuickBooks..."></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                <button type="submit" id="modalSubmitBtn" class="btn btn-primary" style="padding: 0.75rem 2rem;">
                    <i data-lucide="check" style="width: 16px;"></i> <span>Create User</span>
                </button>
                <button type="button" class="btn btn-outline" style="padding: 0.75rem 2rem;"
                    onclick="toggleModal(false)">
                    Cancel
                </button>
            </div>
        </form>

        <div id="defaultPasswordTip" style="font-size: 0.75rem; color: var(--text-lighter);">
            Default password: <code
                style="padding: 0.125rem 0.375rem; background: var(--glass-strong); border-radius: 4px; color: var(--text);">demo123</code>
        </div>
    </div>
</div>

<!-- User Logs Side Panel -->
<div id="logsPanel"
    style="position: fixed; top: 0; right: -480px; width: 480px; height: 100vh; background: var(--surface); border-left: 1px solid var(--border); z-index: 9000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow-y: auto; box-shadow: -10px 0 40px rgba(0,0,0,0.4); display: flex; flex-direction: column;">
    <div
        style="padding: 1.5rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--surface); z-index: 1;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.25rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div
                    style="width: 36px; height: 36px; background: rgba(99,102,241,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i data-lucide="scroll-text" style="width: 18px; color: var(--accent);"></i>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.0625rem; font-weight: 700;">Activity Log</h3>
                    <p id="logsUsername" style="margin: 0; font-size: 0.75rem; color: var(--text-lighter);"></p>
                </div>
            </div>
            <button onclick="closeLogsPanel()" class="btn-ghost" style="padding: 0.5rem; border-radius: 8px;">
                <i data-lucide="x" style="width: 20px;"></i>
            </button>
        </div>
    </div>
    <div id="logsContent" style="padding: 1rem; flex: 1;">
        <div
            style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-lighter);">
            <i data-lucide="loader-2" style="width: 24px; animation: spin 1s linear infinite;"></i>
        </div>
    </div>
</div>
<div id="logsOverlay" onclick="closeLogsPanel()"
    style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 8999; display: none; backdrop-filter: blur(2px);">
</div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="modal-overlay"
    style="display: none; z-index: 9999; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);"
    onclick="closeImagePreview()">
    <div style="position: relative; max-width: 90vw; max-height: 90vh; display: flex; align-items: center; justify-content: center;"
        onclick="event.stopPropagation()">
        <div id="previewContainer"
            style="position: relative; border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <img id="previewImage" src=""
                style="max-width: 100%; max-height: 80vh; display: none; object-fit: contain;">
            <div id="previewIcon"
                style="width: 300px; height: 300px; display: none; align-items: center; justify-content: center; background: var(--glass-strong);">
                <i data-lucide="user" id="previewLucide" style="width: 120px; height: 120px;"></i>
            </div>
            <button onclick="closeImagePreview()" class="btn-ghost"
                style="position: absolute; top: 1rem; right: 1rem; color: white; background: rgba(0,0,0,0.3); border-radius: 50%; padding: 0.5rem;">
                <i data-lucide="x" style="width: 24px;"></i>
            </button>
        </div>
    </div>
</div>

<script>
    let isEditing = false;



    function toggleModal(show, editData = null) {
        const modal = document.getElementById('userModal');
        const form = document.getElementById('userForm');
        const title = document.querySelector('#modalTitle span');
        const icon = document.getElementById('modalIcon');
        const submitBtn = document.querySelector('#modalSubmitBtn span');
        const avatarSection = document.getElementById('avatarSection');
        const passwordTip = document.getElementById('defaultPasswordTip');

        isEditing = !!editData;
        form.reset();

        // Handle Onboarding Section Visibility
        const onboardingSection = document.getElementById('clientOnboardingSection');
        if (onboardingSection) onboardingSection.style.display = 'none';

        if (show) {
            if (isEditing) {
                title.textContent = 'Edit User';
                submitBtn.textContent = 'Save Changes';
                icon.setAttribute('data-lucide', 'user-cog');
                passwordTip.style.display = 'none';

                document.getElementById('editUserId').value = editData.id;
                document.getElementById('currentAvatar').value = editData.avatar_url || '';
                document.getElementById('modalUsername').value = editData.username;
                document.getElementById('modalEmail').value = editData.email;
                document.getElementById('roleInput').value = editData.role;

                if (form.elements['help_needs']) form.elements['help_needs'].value = editData.help_needs || '';
                if (form.elements['software_usage']) form.elements['software_usage'].value = editData.software_usage || '';

                // Load existing avatar if any
                const avatarPreview = document.getElementById('avatarPreview');
                if (editData.avatar_url) {
                    avatarPreview.innerHTML = `<img src="${editData.avatar_url}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    avatarPreview.innerHTML = '<i data-lucide="camera" style="width: 32px; color: var(--text-lighter);"></i>';
                }

                // Select role card
                const roleEl = document.querySelector(`.role-option[data-role="${editData.role}"]`);
                if (roleEl) selectRole(roleEl);
            } else {
                title.textContent = 'Create New User';
                submitBtn.textContent = 'Create User';
                icon.setAttribute('data-lucide', 'user-plus');
                passwordTip.style.display = 'block';

                document.getElementById('editUserId').value = '';
                document.getElementById('currentAvatar').value = '';

                // Default preview
                const avatarPreview = document.getElementById('avatarPreview');
                avatarPreview.innerHTML = '<i data-lucide="camera" style="width: 32px; color: var(--text-lighter);"></i>';

                // Default role
                const clientRoleEl = document.querySelector('.role-option[data-role="client"]');
                if (clientRoleEl) selectRole(clientRoleEl);
            }
            modal.style.display = 'flex';
            lucide.createIcons();
        } else {
            modal.style.display = 'none';
        }
    }

    async function openEditModal(userId) {
        try {
            const response = await fetch(`/api/users/${userId}`);
            const user = await response.json();
            if (user.id) {
                toggleModal(true, user);
            } else {
                showToast(user.message || 'Error fetching user', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    document.getElementById('userForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitBtn = document.getElementById('modalSubmitBtn');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Processing...';

        const url = isEditing ? `/api/users/update/${document.getElementById('editUserId').value}` : '/api/users/create';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
                toggleModal(false);
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast(result.message || 'Action failed', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            lucide.createIcons();
        }
    });

    async function confirmDelete(userId, username) {
        if (!confirm(`Are you sure you want to delete ${username}?`)) return;

        try {
            const response = await fetch(`/api/users/delete/${userId}`, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message, 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showToast(result.message || 'Error deleting user', 'error');
            }
        } catch (error) {
            showToast('Connection error', 'error');
        }
    }

    function filterUsers(role, el) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');

        document.querySelectorAll('.user-item').forEach(item => {
            if (role === 'all' || item.dataset.role === role) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function selectRole(el) {
        document.querySelectorAll('.role-option').forEach(r => {
            r.classList.remove('selected');
            r.style.borderColor = 'var(--border)';
            r.style.background = 'var(--glass)';
        });
        el.classList.add('selected');
        const role = el.dataset.role;
        document.getElementById('roleInput').value = role;

        // Show/hide onboarding section
        const onboardingSection = document.getElementById('clientOnboardingSection');
        if (onboardingSection) {
            onboardingSection.style.display = role === 'client' ? 'block' : 'none';
        }

        const colors = { admin: 'var(--warning)', cs: 'var(--accent)', client: 'var(--success)' };
        el.style.borderColor = colors[role];
        el.style.background = `rgba(${role === 'admin' ? '245, 158, 11' : role === 'cs' ? '59, 130, 246' : '16, 185, 129'}, 0.05)`;
    }

    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const preview = document.getElementById('avatarPreview');
                preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function showImagePreview(url, role = null) {
        const modal = document.getElementById('imagePreviewModal');
        const img = document.getElementById('previewImage');
        const iconDiv = document.getElementById('previewIcon');
        const lucideIcon = document.getElementById('previewLucide');

        if (url && url !== 'None') {
            img.src = url;
            img.style.display = 'block';
            iconDiv.style.display = 'none';
        } else {
            img.style.display = 'none';
            iconDiv.style.display = 'flex';
            const iconName = role === 'admin' ? 'shield' : role === 'client' ? 'briefcase' : 'user-cog';
            lucideIcon.setAttribute('data-lucide', iconName);
            const colors = { admin: 'var(--warning)', cs: 'var(--accent)', client: 'var(--success)' };
            iconDiv.style.color = colors[role] || 'var(--text)';
            iconDiv.style.background = `rgba(${role === 'admin' ? '245, 158, 11' : role === 'cs' ? '59, 130, 246' : '16, 185, 129'}, 0.05)`;
        }

        modal.style.display = 'flex';
        lucide.createIcons();
    }

    function closeImagePreview() {
        document.getElementById('imagePreviewModal').style.display = 'none';
    }

    // ─── Activity Logs Panel ────────────────────────────────────────────
    const ACTION_LABELS = {
        'LOGIN': { icon: 'log-in', color: '#10b981', label: 'Logged In' },
        'LOGOUT': { icon: 'log-out', color: '#6b7280', label: 'Logged Out' },
        'CREATE_USER': { icon: 'user-plus', color: '#3b82f6', label: 'Created User' },
        'UPDATE_USER': { icon: 'user-cog', color: '#f59e0b', label: 'Updated User' },
        'DELETE_USER': { icon: 'user-x', color: '#ef4444', label: 'Deleted User' },
        'VIEW_CANDIDATE': { icon: 'eye', color: '#8b5cf6', label: 'Viewed Candidate' },
        'REQUEST_MEETING': { icon: 'calendar', color: '#06b6d4', label: 'Requested Meeting' },
        'SUBMIT_REJECTION': { icon: 'x-circle', color: '#ef4444', label: 'Rejected Candidate' },
        'SUBMIT_FEEDBACK': { icon: 'message-square', color: '#3b82f6', label: 'Submitted Feedback' },
        'UPDATE_MEETING_STATUS': { icon: 'check-circle', color: '#10b981', label: 'Updated Meeting' },
        'CREATE_CANDIDATE': { icon: 'user-check', color: '#10b981', label: 'Created Candidate' },
    };

    async function openLogsModal(userId, username) {
        const panel = document.getElementById('logsPanel');
        const overlay = document.getElementById('logsOverlay');
        const content = document.getElementById('logsContent');
        document.getElementById('logsUsername').textContent = username;

        // Show loading
        content.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-lighter);">
                <span style="font-size: 0.875rem;">Loading logs...</span>
            </div>`;

        panel.style.right = '0';
        overlay.style.display = 'block';
        lucide.createIcons();

        try {
            const response = await fetch(`/api/users/${userId}/logs`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();

            if (!data.success) {
                content.innerHTML = `<p style="color: var(--error); padding: 1rem;">Failed to load logs.</p>`;
                return;
            }

            if (data.logs.length === 0) {
                content.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; gap: 0.75rem; color: var(--text-lighter);">
                        <i data-lucide="inbox" style="width: 40px; height: 40px;"></i>
                        <p style="margin: 0; font-size: 0.875rem;">No activity recorded yet.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            const rows = data.logs.map(log => {
                const meta = ACTION_LABELS[log.action] || { icon: 'activity', color: '#6b7280', label: log.action };
                const logDate = new Date(log.timestamp + (log.timestamp.includes('+') ? '' : 'Z'));
                const fullDate = logDate.toLocaleString('en-GB', {
                    day: '2-digit', month: 'short', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const diffMs = Date.now() - logDate.getTime();
                const diffSec = Math.floor(diffMs / 1000);
                const diffMin = Math.floor(diffSec / 60);
                const diffHr = Math.floor(diffMin / 60);
                const diffDay = Math.floor(diffHr / 24);
                let time;
                if (diffSec < 60) time = 'Just now';
                else if (diffMin < 60) time = `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
                else if (diffHr < 24) time = `${diffHr} hour${diffHr !== 1 ? 's' : ''} ago`;
                else if (diffDay < 7) time = `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
                else time = fullDate;
                const candidatePart = log.candidate_name
                    ? `<span style="font-size: 0.7rem; color: var(--text-lighter);">• ${log.candidate_name}</span>`
                    : '';
                return `
                    <div style="display: flex; align-items: flex-start; gap: 0.875rem; padding: 0.875rem 0; border-bottom: 1px solid var(--border);">
                        <div style="width: 34px; height: 34px; border-radius: 8px; background: ${meta.color}22; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.1rem;">
                            <i data-lucide="${meta.icon}" style="width: 16px; color: ${meta.color};"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                                <span style="font-size: 0.875rem; font-weight: 600;">${meta.label}</span>
                                ${candidatePart}
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.25rem;">
                                <span style="font-size: 0.7rem; color: var(--text-lighter); cursor: default;" title="${fullDate}">${time}</span>
                                ${log.ip_address ? `<span style="font-size: 0.7rem; color: var(--text-lighter); font-family: monospace;">${log.ip_address}</span>` : ''}
                            </div>
                        </div>
                    </div>`;
            }).join('');

            content.innerHTML = `
                <p style="font-size: 0.75rem; color: var(--text-lighter); margin: 0 0 0.5rem 0;">${data.logs.length} recent activities</p>
                <div>${rows}</div>`;
            lucide.createIcons();
        } catch (err) {
            content.innerHTML = `<p style="color: var(--error); padding: 1rem;">Connection error.</p>`;
        }
    }

    function closeLogsPanel() {
        document.getElementById('logsPanel').style.right = '-480px';
        document.getElementById('logsOverlay').style.display = 'none';
    }
</script>
{% endblock %}