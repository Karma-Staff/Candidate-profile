{% extends "base.html" %}

{% block content %}
<div class="main-container animate-in">
    <!-- Header -->
    <div style="display: flex; align-items: start; gap: 1.5rem; margin-bottom: 3rem;">
        <div
            style="width: 56px; height: 56px; background: var(--glass-strong); border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border);">
            <i data-lucide="bell" style="width: 28px; height: 28px; color: var(--accent);"></i>
        </div>
        <div>
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem;">Notifications</h1>
            <p id="notifStatus" style="color: var(--text-light);">All caught up!</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="filterNotifications('all', this)">All</button>
        <button class="tab-btn" onclick="filterNotifications('unread', this)">Unread</button>
        <button class="tab-btn" onclick="filterNotifications('read', this)">Read</button>
    </div>

    <!-- Notifications List -->
    <div id="fullNotifList" style="display: flex; flex-direction: column; gap: 1rem;">
        <!-- Items will be loaded here via JS -->
    </div>
</div>

<style>
    .notif-card {
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        transition: all var(--transition);
        display: flex;
        gap: 1.25rem;
        position: relative;
    }

    .notif-card:hover {
        background: var(--glass-strong);
        border-color: var(--border-hover);
        transform: translateY(-2px);
    }

    .notif-card.unread {
        border-left: 4px solid var(--accent);
    }

    .notif-card-icon {
        width: 48px;
        height: 48px;
        background: var(--glass-strong);
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border: 1px solid var(--border);
    }

    .notif-card-content {
        flex: 1;
    }

    .notif-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: white;
    }

    .notif-card-msg {
        color: var(--text-light);
        font-size: 0.9375rem;
        line-height: 1.6;
        margin-bottom: 0.75rem;
        max-width: 800px;
    }

    .notif-card-time {
        font-size: 0.875rem;
        color: var(--text-lighter);
        margin-bottom: 1.25rem;
        display: block;
    }

    .remove-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-light);
        font-size: 0.875rem;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: color 0.2s;
        padding: 0;
    }

    .remove-btn:hover {
        color: var(--danger);
    }
</style>

<script>
    let currentFilter = 'all';

    async function loadNotifications() {
        const container = document.getElementById('fullNotifList');
        const statusText = document.getElementById('notifStatus');

        try {
            const response = await fetch('/api/notifications');
            const data = await response.json();

            if (!data.notifications || data.notifications.length === 0) {
                container.innerHTML = `
                    <div style="padding: 5rem 2rem; text-align: center; background: var(--glass); border-radius: var(--radius-xl); border: 1px dashed var(--border);">
                        <i data-lucide="bell-off" style="width: 48px; height: 48px; color: var(--text-lighter); margin-bottom: 1.5rem;"></i>
                        <h3 style="color: white; font-size: 1.25rem; margin-bottom: 0.5rem;">No notifications found</h3>
                        <p style="color: var(--text-light);">We'll alert you when there's an update on your candidates or meetings.</p>
                    </div>
                `;
                statusText.innerText = "All caught up!";
                return;
            }

            let filtered = data.notifications;
            if (currentFilter === 'unread') filtered = data.notifications.filter(n => !n.is_read);
            if (currentFilter === 'read') filtered = data.notifications.filter(n => n.is_read);

            const unreadCount = data.notifications.filter(n => !n.is_read).length;
            statusText.innerText = unreadCount > 0 ? `You have ${unreadCount} unread notification${unreadCount > 1 ? 's' : ''}` : "All caught up!";

            if (filtered.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: var(--text-lighter); padding: 3rem;">No ${currentFilter} notifications.</p>`;
            } else {
                container.innerHTML = filtered.map(n => `
                    <div class="notif-card ${n.is_read ? '' : 'unread'}" id="notif-${n.id}">
                        <div class="notif-card-icon">
                            <i data-lucide="${n.type === 'meeting' ? 'calendar' : 'info'}" style="width: 24px; color: var(--accent);"></i>
                        </div>
                        <div class="notif-card-content">
                            <h3 class="notif-card-title">${n.title}</h3>
                            <p class="notif-card-msg">${n.message}</p>
                            <span class="notif-card-time">${n.time_ago}</span>
                            <button class="remove-btn" onclick="removeNotification(${n.id})">
                                <i data-lucide="trash-2" style="width: 16px;"></i>
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            lucide.createIcons();
        } catch (error) {
            console.error('Error loading notifications:', error);
            container.innerHTML = '<p style="color: var(--danger); text-align: center;">Failed to load notifications.</p>';
        }
    }

    function filterNotifications(filter, btn) {
        currentFilter = filter;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        loadNotifications();
    }

    async function removeNotification(id) {
        if (!confirm('Permanently remove this notification?')) return;

        try {
            const response = await fetch(`/api/notifications/delete/${id}`, { method: 'POST' });
            if (response.ok) {
                const element = document.getElementById(`notif-${id}`);
                element.style.opacity = '0';
                element.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    loadNotifications();
                    // Global update for badge
                    if (window.fetchNotifications) window.fetchNotifications();
                }, 300);
            }
        } catch (error) {
            console.error('Error removing notification:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', loadNotifications);
</script>
{% endblock %}