{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>My Profile</h1>
    <p>Manage your account information and view recent activity</p>
</div>

<div style="display: grid; grid-template-columns: 360px 1fr; gap: 2rem;">
    <!-- Left Column: User Card -->
    <div class="card animate-in delay-1" style="align-self: flex-start; position: relative;">
        <button class="btn-ghost" style="position: absolute; right: 1rem; top: 1rem;">
            <i data-lucide="edit-3" style="width: 18px; color: var(--accent);"></i>
        </button>

        <div style="text-align: center; margin-bottom: 2rem; margin-top: 0.5rem;">
            <div id="user-card-avatar-container" class="avatar avatar-xl avatar-gradient"
                style="margin: 0 auto 1.25rem auto; border: 4px solid var(--border); overflow: hidden; cursor: pointer;"
                title="Click to view profile picture">
                {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="Avatar" id="user-card-avatar"
                    style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <span id="user-card-initials">{{ user.username[:2] | upper }}</span>
                {% endif %}
            </div>
            <h2 style="margin-bottom: 0.375rem; font-size: 1.375rem;">{{ user.username }}</h2>
            <div class="badge badge-{{ user.role }}" style="text-transform: uppercase; letter-spacing: 0.05em;">
                {{ 'Customer Service' if user.role == 'cs' else user.role | title }}
            </div>
        </div>

        <div
            style="display: flex; flex-direction: column; gap: 0.875rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="mail" style="width: 16px; flex-shrink: 0;"></i>
                <span>{{ user.username.replace(' ', '.') | lower }}@restoration.com</span>
            </div>
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="user" style="width: 16px; flex-shrink: 0;"></i>
                <span class="badge badge-{{ user.role }}" style="text-transform: uppercase; font-size: 0.6875rem;">
                    {{ 'Customer Service' if user.role == 'cs' else user.role | title }}
                </span>
            </div>
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="calendar" style="width: 16px; flex-shrink: 0;"></i>
                <span>Member since 2024</span>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- Account Settings -->
        <div class="card animate-in delay-2">
            <h3 style="margin-bottom: 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="settings" style="width: 18px; color: var(--accent);"></i> Account Settings
            </h3>
            <p style="color: var(--text-lighter); font-size: 0.8125rem; margin-bottom: 1.5rem;">Manage your personal
                information and preferences</p>

            <div
                style="background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem;">
                <div id="settings-avatar-container" class="avatar avatar-lg avatar-gradient"
                    style="border: 3px solid var(--border); flex-shrink: 0; overflow: hidden; cursor: pointer;"
                    title="Click to view profile picture">
                    {% if user.avatar_url %}
                    <img src="{{ user.avatar_url }}" alt="Avatar" id="settings-avatar-preview"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    <span id="settings-avatar-initials">{{ user.username[:2] | upper }}</span>
                    {% endif %}
                </div>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Profile Picture</div>
                    <div style="font-size: 0.75rem; color: var(--text-lighter); margin-bottom: 0.75rem;">Upload a new
                        avatar. JPG, GIF or PNG. Max 800K</div>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" id="upload-button"
                        style="padding: 0.375rem 0.875rem; font-size: 0.8125rem;">
                        <i data-lucide="upload" style="width: 14px;"></i> Upload New
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <div style="position: relative;">
                        <i data-lucide="user"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="full_name" class="search-input" style="padding-left: 2.5rem;"
                            value="{{ user.username }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <div style="position: relative;">
                        <i data-lucide="building"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="department" class="search-input" style="padding-left: 2.5rem;"
                            placeholder="e.g. Operations" value="{{ user.department or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <div style="position: relative;">
                        <i data-lucide="mail"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="email" id="email" class="search-input" style="padding-left: 2.5rem;"
                            value="{{ user.email or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Job Title</label>
                    <div style="position: relative;">
                        <i data-lucide="briefcase"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="job_title" class="search-input" style="padding-left: 2.5rem;"
                            placeholder="e.g. Manager" value="{{ user.job_title or '' }}">
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem; gap: 1rem; align-items: center;">
                <span id="update-status" style="font-size: 0.875rem; transition: all 0.3s; opacity: 0;"></span>
                <button id="save-profile" class="btn btn-primary" style="padding: 0.625rem 2rem;">Save Changes</button>
            </div>

            <!-- Image Preview Modal -->
            <div id="image-preview-modal"
                style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 9999; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(4px);">
                <img id="image-preview-full" src=""
                    style="max-width: 90vw; max-height: 90vh; border-radius: var(--radius); box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: contain;">
            </div>

            <script>
                // Image Preview Modal Logic
                const previewModal = document.getElementById('image-preview-modal');
                const previewFullImg = document.getElementById('image-preview-full');

                const openPreview = (imgSrc) => {
                    if (!imgSrc) return;
                    previewFullImg.src = imgSrc;
                    previewModal.style.display = 'flex';
                    previewModal.style.opacity = '0';
                    requestAnimationFrame(() => {
                        previewModal.style.transition = 'opacity 0.2s ease-out';
                        previewModal.style.opacity = '1';
                    });
                };

                previewModal.addEventListener('click', () => {
                    previewModal.style.opacity = '0';
                    setTimeout(() => {
                        previewModal.style.display = 'none';
                    }, 200);
                });

                // Handle Avatar Selection and Preview
                const avatarInput = document.getElementById('avatar-input');
                const uploadBtn = document.getElementById('upload-button');
                const userCardContainer = document.getElementById('user-card-avatar-container');
                const settingsContainer = document.getElementById('settings-avatar-container');

                uploadBtn.addEventListener('click', () => avatarInput.click());

                const handleAvatarClick = (container) => {
                    const img = container.querySelector('img');
                    if (img && img.src) {
                        openPreview(img.src);
                    }
                };

                if (userCardContainer) userCardContainer.addEventListener('click', () => handleAvatarClick(userCardContainer));
                if (settingsContainer) settingsContainer.addEventListener('click', () => handleAvatarClick(settingsContainer));

                avatarInput.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const imgSrc = e.target.result;

                            // Update Settings Preview dynamically
                            let settingsImg = document.getElementById('settings-avatar-preview');
                            if (settingsImg) {
                                settingsImg.src = imgSrc;
                            } else if (settingsContainer) {
                                settingsContainer.innerHTML = `<img src="${imgSrc}" alt="Avatar" id="settings-avatar-preview" style="width: 100%; height: 100%; object-fit: cover;">`;
                            }

                            // Update Card Preview dynamically
                            let cardImg = document.getElementById('user-card-avatar');
                            if (cardImg) {
                                cardImg.src = imgSrc;
                            } else if (userCardContainer) {
                                userCardContainer.innerHTML = `<img src="${imgSrc}" alt="Avatar" id="user-card-avatar" style="width: 100%; height: 100%; object-fit: cover;">`;
                            }
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });

                document.getElementById('save-profile').addEventListener('click', async function () {
                    const btn = this;
                    const status = document.getElementById('update-status');

                    const formData = new FormData();
                    formData.append('full_name', document.getElementById('full_name').value);
                    formData.append('email', document.getElementById('email').value);
                    formData.append('department', document.getElementById('department').value);
                    formData.append('job_title', document.getElementById('job_title').value);

                    if (avatarInput.files[0]) {
                        formData.append('avatar', avatarInput.files[0]);
                    }

                    btn.disabled = true;
                    btn.innerHTML = 'Saving...';
                    status.style.opacity = '0';

                    try {
                        const response = await fetch('/api/profile/update', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        status.textContent = result.message;
                        status.style.opacity = '1';
                        status.style.color = result.success ? 'var(--success)' : 'var(--error)';

                        if (result.success) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    } catch (error) {
                        status.textContent = 'An error occurred';
                        status.style.opacity = '1';
                        status.style.color = 'var(--error)';
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = 'Save Changes';
                    }
                });
            </script>
        </div>

        <!-- Quick Access -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" class="animate-in delay-3">
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;"
                onclick="openModal('modal-security')">
                <div
                    style="width: 40px; height: 40px; background: var(--accent-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="shield" style="width: 20px; color: var(--accent);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Security</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Password, 2FA, Sessions</div>
            </div>
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;"
                onclick="openModal('modal-notifications')">
                <div
                    style="width: 40px; height: 40px; background: var(--success-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="bell" style="width: 20px; color: var(--success);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Notifications</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Email, Desktop, Mobile</div>
            </div>
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;"
                onclick="openModal('modal-privacy')">
                <div
                    style="width: 40px; height: 40px; background: var(--warning-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="lock" style="width: 20px; color: var(--warning);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Privacy</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Data export, Visibility</div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card animate-in delay-4">
            <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="clock" style="width: 20px; color: var(--accent);"></i> Recent Activity
            </h2>

            <div class="timeline">
                {% for activity in activities %}
                <div class="timeline-item" style="--delay: {{ loop.index * 0.1 }}s; animation-delay: var(--delay);">

                    <div class="timeline-dot {{ 'active' if activity.active }}"></div>
                    <div style="display: flex; flex-direction: column; gap: 0.125rem;">
                        <div style="font-weight: 600; font-size: 0.9375rem;">{{ activity.title }}</div>
                        {% if activity.subtitle %}
                        <div style="font-size: 0.8125rem; font-weight: 500; color: var(--text-light);">{{
                            activity.subtitle }}</div>
                        {% endif %}
                        <div style="font-size: 0.8125rem; color: var(--text-lighter);">{{ activity.time | timesince }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modals for Settings Cards -->
<style>
    .pref-modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.85);
        /* Darker blur backdrop */
        backdrop-filter: blur(8px);
        z-index: 9998;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s ease-out;
    }

    .pref-modal {
        background: #1e293b;
        /* Slate 800 for better contrast */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        width: 100%;
        max-width: 480px;
        padding: 2.5rem;
        transform: translateY(20px);
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        color: #f8fafc;
    }

    .pref-modal.show {
        transform: translateY(0);
    }

    /* Fix the Toast Z-Index so it shows above the modal */
    .toast-container {
        z-index: 99999 !important;
    }

    .toast {
        z-index: 99999 !important;
    }

    /* Modal Form Inputs */
    .pref-modal .search-input {
        background: #0f172a;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        padding: 0.875rem 1rem;
        border-radius: 10px;
        transition: border-color 0.2s;
    }

    .pref-modal .search-input:focus {
        border-color: #3b82f6;
        outline: none;
    }

    /* Better Checkbox Alignment */
    .pref-checkbox-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 1.25rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: background 0.2s;
    }

    .pref-checkbox-row:hover {
        background: rgba(255, 255, 255, 0.06);
    }
</style>

<!-- Security Modal -->
<div id="modal-security" class="pref-modal-overlay" onclick="if(event.target===this) closeModal('modal-security')">
    <div class="pref-modal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Security Settings</h3>
            <button class="btn-ghost" onclick="closeModal('modal-security')"
                style="background: transparent; border: none; cursor: pointer; color: #94a3b8; padding: 0.5rem; border-radius: 8px;">
                <i data-lucide="x" style="width: 24px;"></i>
            </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
            <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" id="sec-current-pwd" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="sec-new-pwd" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="sec-confirm-pwd" class="search-input"
                    style="width: 100%; box-sizing: border-box;">
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end;">
            <button class="btn btn-primary" onclick="saveSecurity()" id="btn-save-sec">Update Password</button>
        </div>
    </div>
</div>

<!-- Notifications Modal -->
<div id="modal-notifications" class="pref-modal-overlay"
    onclick="if(event.target===this) closeModal('modal-notifications')">
    <div class="pref-modal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Notification Preferences</h3>
            <button class="btn-ghost" onclick="closeModal('modal-notifications')"
                style="background: transparent; border: none; cursor: pointer; color: #94a3b8; padding: 0.5rem; border-radius: 8px;">
                <i data-lucide="x" style="width: 24px;"></i>
            </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
            <label class="pref-checkbox-row">
                <div>
                    <div style="font-weight: 600; font-size: 1rem;">Email Notifications</div>
                    <div style="font-size: 0.8125rem; color: #94a3b8; margin-top: 0.25rem;">Receive updates directly to
                        your inbox.</div>
                </div>
                <!-- Adding a custom-colored modern checkbox -->
                <input type="checkbox" id="pref-email" {% if user.notifications_email !=0 %}checked{% endif %}
                    style="width: 24px; height: 24px; accent-color: #3b82f6; cursor: pointer;">
            </label>
            <label class="pref-checkbox-row">
                <div>
                    <div style="font-weight: 600; font-size: 1rem;">Desktop Notifications</div>
                    <div style="font-size: 0.8125rem; color: #94a3b8; margin-top: 0.25rem;">Show popup alerts when
                        active.</div>
                </div>
                <input type="checkbox" id="pref-desktop" {% if user.notifications_desktop !=0 %}checked{% endif %}
                    style="width: 24px; height: 24px; accent-color: #3b82f6; cursor: pointer;">
            </label>
        </div>
        <div style="display: flex; justify-content: flex-end;">
            <button class="btn btn-primary" onclick="savePreferences()" id="btn-save-notif">Save Preferences</button>
        </div>
    </div>
</div>

<!-- Privacy Modal -->
<div id="modal-privacy" class="pref-modal-overlay" onclick="if(event.target===this) closeModal('modal-privacy')">
    <div class="pref-modal">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h3 style="margin: 0; font-size: 1.5rem; font-weight: 600;">Privacy Settings</h3>
            <button class="btn-ghost" onclick="closeModal('modal-privacy')"
                style="background: transparent; border: none; cursor: pointer; color: #94a3b8; padding: 0.5rem; border-radius: 8px;">
                <i data-lucide="x" style="width: 24px;"></i>
            </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1.25rem; margin-bottom: 1.5rem;">
            <div class="form-group">
                <label class="form-label">Profile Visibility</label>
                <select id="pref-visibility" class="search-input"
                    style="width: 100%; box-sizing: border-box; padding: 0.75rem;">
                    <option value="Public" {% if user.privacy_profile_visibility=='Public' %}selected{% endif %}>Public
                        (Everyone)</option>
                    <option value="Internal" {% if user.privacy_profile_visibility=='Internal' %}selected{% endif %}>
                        Internal Only (Team)</option>
                    <option value="Private" {% if user.privacy_profile_visibility=='Private' %}selected{% endif %}>
                        Private (Only Me)</option>
                </select>
                <div style="font-size: 0.75rem; color: var(--text-lighter); margin-top: 0.5rem;">Control who can see
                    your contact info internally.</div>
            </div>
            <div
                style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: var(--radius);">
                <div style="font-weight: 600; color: #ef4444; margin-bottom: 0.25rem;">Export Data</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter); margin-bottom: 0.75rem;">Download a copy of
                    your personal data.</div>
                <button class="btn btn-outline" style="font-size: 0.75rem; color: white;"
                    onclick="showToast('Your data export is being generated. You will receive an email shortly.', 'info')">Request
                    Export</button>
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end;">
            <button class="btn btn-primary" onclick="savePreferences()" id="btn-save-priv">Save Preferences</button>
        </div>
    </div>
</div>

<script>
    // Ensure icons are initialized on the profile page
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    function openModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
        // Force reflow
        void modal.offsetWidth;
        modal.style.opacity = '1';
        modal.querySelector('.pref-modal').classList.add('show');
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        modal.style.opacity = '0';
        modal.querySelector('.pref-modal').classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 200);
    }

    async function saveSecurity() {
        const curr = document.getElementById('sec-current-pwd').value;
        const newP = document.getElementById('sec-new-pwd').value;
        const conf = document.getElementById('sec-confirm-pwd').value;

        if (!curr || !newP) {
            return showToast('Please fill in both password fields.', 'warning');
        }
        if (newP !== conf) {
            return showToast('New passwords do not match.', 'error');
        }

        const btn = document.getElementById('btn-save-sec');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const res = await fetch('/api/profile/security', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_password: curr, new_password: newP })
            });
            const data = await res.json();

            if (res.ok && data.success) {
                btn.innerText = "Success!";
                showToast(data.message, 'success');
                setTimeout(() => {
                    closeModal('modal-security');
                    document.getElementById('sec-current-pwd').value = '';
                    document.getElementById('sec-new-pwd').value = '';
                    document.getElementById('sec-confirm-pwd').value = '';
                }, 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (e) {
            showToast('Network error occurred.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = "Update Password";
        }
    }

    async function savePreferences() {
        const email = document.getElementById('pref-email').checked;
        const desktop = document.getElementById('pref-desktop').checked;
        const visibility = document.getElementById('pref-visibility').value;

        const btnNotif = document.getElementById('btn-save-notif');
        const btnPriv = document.getElementById('btn-save-priv');
        btnNotif.disabled = true;
        btnPriv.disabled = true;

        try {
            const res = await fetch('/api/profile/preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    notifications_email: email,
                    notifications_desktop: desktop,
                    privacy_profile_visibility: visibility
                })
            });
            const data = await res.json();

            if (res.ok && data.success) {
                btnNotif.innerText = "Saved!";
                btnPriv.innerText = "Saved!";
                showToast(data.message, 'success');
                setTimeout(() => {
                    closeModal('modal-notifications');
                    closeModal('modal-privacy');
                    window.location.reload();
                }, 1000);
            } else {
                showToast(data.message, 'error');
            }
        } catch (e) {
            showToast('Network error occurred.', 'error');
        } finally {
            btnNotif.disabled = false;
            btnPriv.disabled = false;
        }
    }
</script>
{% endblock %}