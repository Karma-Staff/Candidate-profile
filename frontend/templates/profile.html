{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>My Profile</h1>
    <p>Manage your account information and view recent activity</p>
</div>

<div style="display: grid; grid-template-columns: 360px 1fr; gap: 2rem;">
    <!-- Left Column: User Card -->
    <div class="card animate-in delay-1" style="align-self: flex-start; position: relative;">
        <button class="btn-ghost" style="position: absolute; right: 1rem; top: 1rem;">
            <i data-lucide="edit-3" style="width: 18px; color: var(--accent);"></i>
        </button>

        <div style="text-align: center; margin-bottom: 2rem; margin-top: 0.5rem;">
            <div id="user-card-avatar-container" class="avatar avatar-xl avatar-gradient"
                style="margin: 0 auto 1.25rem auto; border: 4px solid var(--border); overflow: hidden; cursor: pointer;"
                title="Click to view profile picture">
                {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="Avatar" id="user-card-avatar"
                    style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                <span id="user-card-initials">{{ user.username[:2] | upper }}</span>
                {% endif %}
            </div>
            <h2 style="margin-bottom: 0.375rem; font-size: 1.375rem;">{{ user.username }}</h2>
            <div class="badge badge-{{ user.role }}" style="text-transform: uppercase; letter-spacing: 0.05em;">
                {{ 'Customer Service' if user.role == 'cs' else user.role | title }}
            </div>
        </div>

        <div
            style="display: flex; flex-direction: column; gap: 0.875rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="mail" style="width: 16px; flex-shrink: 0;"></i>
                <span>{{ user.username.replace(' ', '.') | lower }}@restoration.com</span>
            </div>
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="user" style="width: 16px; flex-shrink: 0;"></i>
                <span class="badge badge-{{ user.role }}" style="text-transform: uppercase; font-size: 0.6875rem;">
                    {{ 'Customer Service' if user.role == 'cs' else user.role | title }}
                </span>
            </div>
            <div
                style="display: flex; align-items: center; gap: 0.75rem; color: var(--text-light); font-size: 0.875rem;">
                <i data-lucide="calendar" style="width: 16px; flex-shrink: 0;"></i>
                <span>Member since 2024</span>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
        <!-- Account Settings -->
        <div class="card animate-in delay-2">
            <h3 style="margin-bottom: 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="settings" style="width: 18px; color: var(--accent);"></i> Account Settings
            </h3>
            <p style="color: var(--text-lighter); font-size: 0.8125rem; margin-bottom: 1.5rem;">Manage your personal
                information and preferences</p>

            <div
                style="background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem;">
                <div id="settings-avatar-container" class="avatar avatar-lg avatar-gradient"
                    style="border: 3px solid var(--border); flex-shrink: 0; overflow: hidden; cursor: pointer;"
                    title="Click to view profile picture">
                    {% if user.avatar_url %}
                    <img src="{{ user.avatar_url }}" alt="Avatar" id="settings-avatar-preview"
                        style="width: 100%; height: 100%; object-fit: cover;">
                    {% else %}
                    <span id="settings-avatar-initials">{{ user.username[:2] | upper }}</span>
                    {% endif %}
                </div>
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">Profile Picture</div>
                    <div style="font-size: 0.75rem; color: var(--text-lighter); margin-bottom: 0.75rem;">Upload a new
                        avatar. JPG, GIF or PNG. Max 800K</div>
                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                    <button class="btn btn-outline" id="upload-button"
                        style="padding: 0.375rem 0.875rem; font-size: 0.8125rem;">
                        <i data-lucide="upload" style="width: 14px;"></i> Upload New
                    </button>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <div style="position: relative;">
                        <i data-lucide="user"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="full_name" class="search-input" style="padding-left: 2.5rem;"
                            value="{{ user.username }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <div style="position: relative;">
                        <i data-lucide="building"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="department" class="search-input" style="padding-left: 2.5rem;"
                            placeholder="e.g. Operations" value="{{ user.department or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <div style="position: relative;">
                        <i data-lucide="mail"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="email" id="email" class="search-input" style="padding-left: 2.5rem;"
                            value="{{ user.email or '' }}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Job Title</label>
                    <div style="position: relative;">
                        <i data-lucide="briefcase"
                            style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 16px; color: var(--text-lighter);"></i>
                        <input type="text" id="job_title" class="search-input" style="padding-left: 2.5rem;"
                            placeholder="e.g. Manager" value="{{ user.job_title or '' }}">
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem; gap: 1rem; align-items: center;">
                <span id="update-status" style="font-size: 0.875rem; transition: all 0.3s; opacity: 0;"></span>
                <button id="save-profile" class="btn btn-primary" style="padding: 0.625rem 2rem;">Save Changes</button>
            </div>

            <!-- Image Preview Modal -->
            <div id="image-preview-modal"
                style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 9999; justify-content: center; align-items: center; cursor: zoom-out; backdrop-filter: blur(4px);">
                <img id="image-preview-full" src=""
                    style="max-width: 90vw; max-height: 90vh; border-radius: var(--radius); box-shadow: 0 10px 40px rgba(0,0,0,0.5); object-fit: contain;">
            </div>

            <script>
                // Image Preview Modal Logic
                const previewModal = document.getElementById('image-preview-modal');
                const previewFullImg = document.getElementById('image-preview-full');

                const openPreview = (imgSrc) => {
                    if (!imgSrc) return;
                    previewFullImg.src = imgSrc;
                    previewModal.style.display = 'flex';
                    previewModal.style.opacity = '0';
                    requestAnimationFrame(() => {
                        previewModal.style.transition = 'opacity 0.2s ease-out';
                        previewModal.style.opacity = '1';
                    });
                };

                previewModal.addEventListener('click', () => {
                    previewModal.style.opacity = '0';
                    setTimeout(() => {
                        previewModal.style.display = 'none';
                    }, 200);
                });

                // Handle Avatar Selection and Preview
                const avatarInput = document.getElementById('avatar-input');
                const uploadBtn = document.getElementById('upload-button');
                const userCardContainer = document.getElementById('user-card-avatar-container');
                const settingsContainer = document.getElementById('settings-avatar-container');

                uploadBtn.addEventListener('click', () => avatarInput.click());

                const handleAvatarClick = (container) => {
                    const img = container.querySelector('img');
                    if (img && img.src) {
                        openPreview(img.src);
                    }
                };

                if (userCardContainer) userCardContainer.addEventListener('click', () => handleAvatarClick(userCardContainer));
                if (settingsContainer) settingsContainer.addEventListener('click', () => handleAvatarClick(settingsContainer));

                avatarInput.addEventListener('change', function () {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const imgSrc = e.target.result;

                            // Update Settings Preview dynamically
                            let settingsImg = document.getElementById('settings-avatar-preview');
                            if (settingsImg) {
                                settingsImg.src = imgSrc;
                            } else if (settingsContainer) {
                                settingsContainer.innerHTML = `<img src="${imgSrc}" alt="Avatar" id="settings-avatar-preview" style="width: 100%; height: 100%; object-fit: cover;">`;
                            }

                            // Update Card Preview dynamically
                            let cardImg = document.getElementById('user-card-avatar');
                            if (cardImg) {
                                cardImg.src = imgSrc;
                            } else if (userCardContainer) {
                                userCardContainer.innerHTML = `<img src="${imgSrc}" alt="Avatar" id="user-card-avatar" style="width: 100%; height: 100%; object-fit: cover;">`;
                            }
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });

                document.getElementById('save-profile').addEventListener('click', async function () {
                    const btn = this;
                    const status = document.getElementById('update-status');

                    const formData = new FormData();
                    formData.append('full_name', document.getElementById('full_name').value);
                    formData.append('email', document.getElementById('email').value);
                    formData.append('department', document.getElementById('department').value);
                    formData.append('job_title', document.getElementById('job_title').value);

                    if (avatarInput.files[0]) {
                        formData.append('avatar', avatarInput.files[0]);
                    }

                    btn.disabled = true;
                    btn.innerHTML = 'Saving...';
                    status.style.opacity = '0';

                    try {
                        const response = await fetch('/api/profile/update', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        status.textContent = result.message;
                        status.style.opacity = '1';
                        status.style.color = result.success ? 'var(--success)' : 'var(--error)';

                        if (result.success) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    } catch (error) {
                        status.textContent = 'An error occurred';
                        status.style.opacity = '1';
                        status.style.color = 'var(--error)';
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = 'Save Changes';
                    }
                });
            </script>
        </div>

        <!-- Quick Access -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;" class="animate-in delay-3">
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;">
                <div
                    style="width: 40px; height: 40px; background: var(--accent-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="shield" style="width: 20px; color: var(--accent);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Security</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Password, 2FA, Sessions</div>
            </div>
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;">
                <div
                    style="width: 40px; height: 40px; background: var(--success-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="bell" style="width: 20px; color: var(--success);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Notifications</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Email, Desktop, Mobile</div>
            </div>
            <div class="card card-hover" style="text-align: center; padding: 1.5rem; cursor: pointer;">
                <div
                    style="width: 40px; height: 40px; background: var(--warning-subtle); border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 0.75rem;">
                    <i data-lucide="lock" style="width: 20px; color: var(--warning);"></i>
                </div>
                <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 0.125rem;">Privacy</div>
                <div style="font-size: 0.75rem; color: var(--text-lighter);">Data export, Visibility</div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card animate-in delay-4">
            <h2 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="clock" style="width: 20px; color: var(--accent);"></i> Recent Activity
            </h2>

            <div class="timeline">
                {% for activity in activities %}
                <div class="timeline-item" style="--delay: {{ loop.index * 0.1 }}s; animation-delay: var(--delay);">

                    <div class="timeline-dot {{ 'active' if activity.active }}"></div>
                    <div style="display: flex; flex-direction: column; gap: 0.125rem;">
                        <div style="font-weight: 600; font-size: 0.9375rem;">{{ activity.title }}</div>
                        {% if activity.subtitle %}
                        <div style="font-size: 0.8125rem; font-weight: 500; color: var(--text-light);">{{
                            activity.subtitle }}</div>
                        {% endif %}
                        <div style="font-size: 0.8125rem; color: var(--text-lighter);">{{ activity.time }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}